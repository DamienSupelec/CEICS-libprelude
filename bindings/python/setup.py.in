import sys, os
from os.path import abspath, exists
import shutil

from distutils.sysconfig import get_python_lib
from distutils.core import setup, Extension

def split_args(s):
    import re
    return re.split("\s+", s.strip())
    

if sys.argv[1] == "install":
    if not os.access(get_python_lib(), os.W_OK):
        sys.argv.extend(["--prefix", "@prefix@"])

if sys.argv[1] == "build":
    if "@top_srcdir@" != "@top_builddir@":
        for filename in "_prelude.c", "prelude.py":
            src = "@top_srcdir@/bindings/python/" + filename
            dst = "@top_builddir@/bindings/python/" + filename
            if not exists(dst):
                shutil.copy(src, dst)

setup(name="prelude",
      package_dir={'prelude': '@top_srcdir@/bindings/python'},
      py_modules=["prelude"],
      ext_modules=[Extension("_prelude",
                             ["_prelude.c"],
                             extra_compile_args=split_args("-I@top_srcdir@/src/include -I@top_builddir@/src/include"),
                             extra_link_args=split_args("@PTHREAD_CFLAGS@ @libprelude_libs@ "
                                                        "-L@top_builddir@/src/.libs -lprelude"))])
